{% extends "admin_portal/base.html" %}
{% load core_tags %}

{% block title %}Preview Campaign: {{ campaign.name }} - PropManager Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-eye"></i> Preview: {{ campaign.name }}</h2>
    <a href="{% url 'marketing_admin:campaign_detail' pk=campaign.pk %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Campaign
    </a>
</div>

<!-- Recipient Count -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted mb-1">Resolved Recipients</h6>
                <h2 class="mb-0">{{ recipient_count }}</h2>
                <small class="text-muted">tenant{{ recipient_count|pluralize }} will receive this campaign</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted mb-1">Subject</h6>
                <h5 class="mb-0">{{ campaign.subject }}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h6 class="text-muted mb-1">Status</h6>
                <h5 class="mb-0">
                    {% if campaign.status == "draft" %}
                        <span class="badge bg-secondary">Draft</span>
                    {% elif campaign.status == "scheduled" %}
                        <span class="badge bg-info">Scheduled</span>
                    {% elif campaign.status == "sending" %}
                        <span class="badge bg-warning text-dark">Sending</span>
                    {% elif campaign.status == "sent" %}
                        <span class="badge bg-success">Sent</span>
                    {% elif campaign.status == "cancelled" %}
                        <span class="badge bg-danger">Cancelled</span>
                    {% endif %}
                </h5>
            </div>
        </div>
    </div>
</div>

<!-- Recipients Preview -->
{% if recipients_preview %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-people"></i> Recipients Preview (first 20)</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tenant in recipients_preview %}
                    <tr>
                        <td>{{ tenant.get_full_name|default:tenant.username }}</td>
                        <td>{{ tenant.email }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if recipient_count > 20 %}
    <div class="card-footer text-muted text-center">
        ... and {{ recipient_count|add:"-20" }} more recipient{{ recipient_count|add:"-20"|pluralize }}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- HTML Preview -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-code-slash"></i> HTML Email Preview</h5>
    </div>
    <div class="card-body p-0">
        {% if campaign.body_html %}
        <iframe id="preview-frame" style="width: 100%; min-height: 500px; border: none;"></iframe>
        {% else %}
        <div class="text-center text-muted py-5">
            <i class="bi bi-file-earmark-x" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">No HTML content to preview.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Plain Text Preview -->
{% if campaign.body_text %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-file-text"></i> Plain Text Preview</h5>
    </div>
    <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap;">{{ campaign.body_text }}</pre>
    </div>
</div>
{% endif %}

<!-- Actions -->
{% if campaign.status == "draft" %}
<div class="d-flex gap-2">
    <form method="post" action="{% url 'marketing_admin:campaign_send' pk=campaign.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success"
                onclick="return confirm('Are you sure you want to send this campaign to {{ recipient_count }} recipient{{ recipient_count|pluralize }}?');">
            <i class="bi bi-send"></i> {% if campaign.scheduled_at %}Schedule Send{% else %}Send Now{% endif %}
        </button>
    </form>
    <a href="{% url 'marketing_admin:campaign_edit' pk=campaign.pk %}" class="btn btn-outline-primary">
        <i class="bi bi-pencil"></i> Edit Campaign
    </a>
</div>
{% endif %}

{% if campaign.body_html %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    var iframe = document.getElementById("preview-frame");
    if (iframe) {
        var htmlContent = "{{ campaign.body_html|escapejs }}";
        var doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(htmlContent);
        doc.close();
        // Auto-resize iframe to content height
        setTimeout(function () {
            try {
                iframe.style.height = doc.body.scrollHeight + 40 + "px";
            } catch (e) {}
        }, 200);
    }
});
</script>
{% endif %}
{% endblock %}
