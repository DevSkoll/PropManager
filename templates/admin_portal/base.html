{% extends "base.html" %}
{% load static %}
{% load core_tags %}

{% block body_class %}admin-portal{% endblock %}

{% block body %}
<!-- Top Navigation Bar -->
<nav class="navbar navbar-dark bg-dark admin-topnav">
    <div class="container-fluid">
        <!-- Left: Brand + Launcher -->
        <div class="d-flex align-items-center">
            <!-- App Launcher Button -->
            <button class="btn btn-dark launcher-btn me-2" type="button" data-bs-toggle="modal" data-bs-target="#appLauncherModal" title="All Apps (Ctrl+/)">
                <i class="bi bi-grid-3x3-gap-fill"></i>
            </button>

            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="{% url 'accounts_admin:admin_dashboard' %}">
                <i class="bi bi-building-gear me-2"></i>
                <span class="d-none d-md-inline">PropManager</span>
            </a>
        </div>

        {% if user.is_authenticated and user.is_admin_user %}
        <!-- Center: Global Search -->
        <div class="nav-search-container">
            <div class="nav-search">
                <i class="bi bi-search search-icon"></i>
                <input type="text"
                       id="globalSearch"
                       class="form-control"
                       placeholder="Search apps, tenants, properties..."
                       autocomplete="off">
                <span class="search-shortcut d-none d-md-flex">
                    <kbd>Ctrl</kbd><kbd>K</kbd>
                </span>
            </div>
            <!-- Search Results Dropdown -->
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- Right: Recent Apps + User -->
        <div class="d-flex align-items-center">
            <!-- Recent Apps Dropdown -->
            <div class="dropdown me-2">
                <button class="btn btn-dark nav-icon-btn" type="button" data-bs-toggle="dropdown" title="Recent">
                    <i class="bi bi-clock-history"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-end recent-apps-dropdown" id="recentAppsDropdown">
                    <h6 class="dropdown-header">
                        <i class="bi bi-clock me-2"></i>Recently Used
                    </h6>
                    <div id="recentAppsList">
                        <p class="dropdown-item-text text-muted small">No recent apps</p>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item text-muted small" onclick="clearRecentApps()">
                        <i class="bi bi-trash me-2"></i>Clear History
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dropdown me-2 d-none d-lg-block">
                <button class="btn btn-dark nav-icon-btn" type="button" data-bs-toggle="dropdown" title="Quick Actions">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <h6 class="dropdown-header">Quick Actions</h6>
                    <a class="dropdown-item" href="{% url 'leases_admin:lease_create' %}">
                        <i class="bi bi-file-earmark-plus me-2"></i>New Lease
                    </a>
                    <a class="dropdown-item" href="{% url 'workorders_admin:workorder_create' %}">
                        <i class="bi bi-tools me-2"></i>New Work Order
                    </a>
                    <a class="dropdown-item" href="{% url 'billing_admin:invoice_create' %}">
                        <i class="bi bi-receipt me-2"></i>New Invoice
                    </a>
                    <a class="dropdown-item" href="{% url 'tenant_lifecycle_admin:admin_session_create' %}">
                        <i class="bi bi-person-plus me-2"></i>Invite Tenant
                    </a>
                </div>
            </div>

            <!-- User Menu -->
            <div class="dropdown">
                <button class="btn btn-dark nav-user-btn" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i>
                    <span class="d-none d-md-inline ms-1">{{ user.first_name|default:user.username }}</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <div class="dropdown-header">
                        <strong>{{ user.get_full_name|default:user.username }}</strong>
                        <br><small class="text-muted">{{ user.email }}</small>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'accounts_admin:admin_settings' %}">
                        <i class="bi bi-gear me-2"></i>Settings
                    </a>
                    <a class="dropdown-item" href="{% url 'accounts_admin:admin_dashboard' %}">
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="{% url 'accounts_admin:admin_logout' %}">
                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid py-4">
    <div class="row">
        <main class="col-12">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- App Launcher Modal -->
<div class="modal fade" id="appLauncherModal" tabindex="-1" aria-labelledby="appLauncherTitle" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-md-down modal-xl">
        <div class="modal-content launcher-modal">
            <div class="modal-header border-0 pb-0">
                <div class="launcher-header w-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="modal-title" id="appLauncherTitle">
                            <i class="bi bi-grid-3x3-gap-fill me-2"></i>All Apps
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <!-- Launcher Search -->
                    <div class="launcher-search">
                        <i class="bi bi-search"></i>
                        <input type="text" id="launcherSearch" class="form-control" placeholder="Search apps..." autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="modal-body pt-3">
                <!-- Pinned Apps -->
                <div class="launcher-section" id="pinnedSection" style="display: none;">
                    <h6 class="launcher-section-title">
                        <i class="bi bi-pin-angle me-2"></i>Pinned
                    </h6>
                    <div class="launcher-grid" id="pinnedApps"></div>
                </div>

                <!-- Recent Apps in Modal -->
                <div class="launcher-section" id="recentSection">
                    <h6 class="launcher-section-title">
                        <i class="bi bi-clock-history me-2"></i>Recent
                    </h6>
                    <div class="launcher-grid" id="modalRecentApps">
                        <p class="text-muted small">No recent apps</p>
                    </div>
                </div>

                <!-- All Apps by Category -->
                <div id="launcherCategories"></div>

                <!-- No Results -->
                <div id="launcherNoResults" class="text-center py-5" style="display: none;">
                    <i class="bi bi-search fs-1 text-muted"></i>
                    <p class="text-muted mt-2">No apps found</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- App Tiles Data (populated by context processor) -->
<script id="appTilesData" type="application/json">{{ app_tiles_json|default:"[]"|safe }}</script>
<script id="categoryInfoData" type="application/json">{{ category_info_json|default:"{}"|safe }}</script>

<!-- Nav Launcher Styles -->
<link rel="stylesheet" href="{% static 'css/nav-launcher.css' %}">
<!-- Nav Launcher Script -->
<script src="{% static 'js/nav-launcher.js' %}"></script>
{% endblock %}
