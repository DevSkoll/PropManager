{% extends "admin_portal/base.html" %}
{% load core_tags %}

{% block title %}Tenants - PropManager Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people"></i> Tenants</h2>
</div>

<!-- Status Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'active' %}active{% endif %}" href="?status=active{% if search %}&search={{ search }}{% endif %}">
            Active <span class="badge bg-success">{{ active_count }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'archived' %}active{% endif %}" href="?status=archived{% if search %}&search={{ search }}{% endif %}">
            Archived <span class="badge bg-secondary">{{ archived_count }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'all' %}active{% endif %}" href="?status=all{% if search %}&search={{ search }}{% endif %}">
            All <span class="badge bg-primary">{{ active_count|add:archived_count }}</span>
        </a>
    </li>
</ul>

<!-- Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <input type="hidden" name="status" value="{{ status_filter }}">
            <div class="col-md-8">
                <label class="form-label">Search</label>
                <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="Name, email, or phone...">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Search</button>
                <a href="?status={{ status_filter }}" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Unit</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in tenant_data %}
                <tr class="tenant-row" style="cursor: pointer;" data-tenant-id="{{ item.user.pk }}">
                    <td class="fw-semibold">{{ item.user.get_full_name|default:item.user.username }}</td>
                    <td>{{ item.user.email }}</td>
                    <td>{{ item.user.phone_number|default:"-" }}</td>
                    <td>
                        {% if item.active_lease %}
                            <a href="{% url 'properties_admin:unit_detail' property_pk=item.active_lease.unit.property.pk pk=item.active_lease.unit.pk %}" onclick="event.stopPropagation();">
                                {{ item.active_lease.unit.property.name }} - {{ item.active_lease.unit.unit_number }}
                            </a>
                        {% else %}
                            <span class="text-muted">No active lease</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.user.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Archived</span>
                        {% endif %}
                        {% if not item.active_lease and item.can_delete %}
                            <span class="badge bg-light text-dark border" title="Can be deleted"><i class="bi bi-trash"></i></span>
                        {% endif %}
                    </td>
                    <td class="text-end" onclick="event.stopPropagation();">
                        {% if item.user.is_archived %}
                            <form action="{% url 'accounts_admin:admin_tenant_restore' pk=item.user.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Restore">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </form>
                        {% else %}
                            <form action="{% url 'accounts_admin:admin_tenant_archive' pk=item.user.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-warning" title="Archive" onclick="return confirm('Archive this tenant?');">
                                    <i class="bi bi-archive"></i>
                                </button>
                            </form>
                        {% endif %}
                        {% if item.can_delete %}
                            <form action="{% url 'accounts_admin:admin_tenant_delete' pk=item.user.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Permanently delete this tenant? This cannot be undone.');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-people" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">
                            {% if status_filter == 'archived' %}
                                No archived tenants.
                            {% elif search %}
                                No tenants found matching "{{ search }}".
                            {% else %}
                                No tenants found.
                            {% endif %}
                        </p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Tenant Detail Modal -->
<div class="modal fade" id="tenantDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('tenantDetailModal');
    const modalContent = modal.querySelector('.modal-content');
    const bsModal = new bootstrap.Modal(modal);

    // Click on tenant row to open modal
    document.querySelectorAll('.tenant-row').forEach(row => {
        row.addEventListener('click', function() {
            const tenantId = this.dataset.tenantId;
            loadTenantDetail(tenantId);
        });
    });

    function loadTenantDetail(tenantId) {
        // Show loading state
        modalContent.innerHTML = `
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        bsModal.show();

        // Fetch tenant detail
        fetch(`/admin-portal/tenants/${tenantId}/modal/`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to load tenant details');
                return response.text();
            })
            .then(html => {
                modalContent.innerHTML = html;
            })
            .catch(error => {
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h5 class="modal-title">Error</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-exclamation-triangle"></i> ${error.message}
                        </div>
                    </div>
                `;
            });
    }

    // Reset modal content when closed
    modal.addEventListener('hidden.bs.modal', function() {
        modalContent.innerHTML = `
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
    });
});
</script>
{% endblock %}
