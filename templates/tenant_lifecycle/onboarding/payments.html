{% extends "tenant_lifecycle/onboarding/base.html" %}

{% block title %}Move-In Payments{% endblock %}

{% block content %}
<div class="onboarding-card">
    <div class="onboarding-card-header">
        <h2 class="h4 mb-1">
            <i class="bi bi-credit-card me-2 text-primary"></i>
            {{ step_name }}
        </h2>
        <p class="text-muted mb-0">Complete your move-in payments</p>
    </div>

    <div class="onboarding-card-body">
        {% if completed_payments %}
        <div class="mb-4">
            <h6 class="text-success mb-3">
                <i class="bi bi-check-circle me-1"></i>
                Completed Payments
            </h6>
            {% for payment in completed_payments %}
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <span>{{ payment.description }}</span>
                    {% if payment.is_refundable %}
                    <small class="text-muted">(Refundable)</small>
                    {% endif %}
                </div>
                <span class="text-success">
                    <i class="bi bi-check me-1"></i>
                    ${{ payment.amount }}
                </span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if pending_payments %}
        <form method="post" action="{% url 'tenant_lifecycle:onboarding_payments_process' token=session.access_token %}">
            {% csrf_token %}

            <h6 class="text-muted mb-3">Pending Payments</h6>

            {% for payment in pending_payments %}
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="payment_ids" value="{{ payment.pk }}"
                           id="payment_{{ payment.pk }}" {% if payment.template_fee.is_required %}checked disabled{% endif %}>
                    <label class="form-check-label" for="payment_{{ payment.pk }}">
                        {{ payment.description }}
                        {% if payment.is_refundable %}
                        <small class="text-muted">(Refundable)</small>
                        {% endif %}
                        {% if payment.template_fee.is_required %}
                        <span class="badge bg-warning text-dark">Required</span>
                        {% endif %}
                    </label>
                </div>
                <strong>${{ payment.amount }}</strong>
            </div>
            {% if payment.template_fee.is_required %}
            <input type="hidden" name="payment_ids" value="{{ payment.pk }}">
            {% endif %}
            {% endfor %}

            <div class="bg-light rounded p-3 mt-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Total Due</h5>
                    <h4 class="mb-0 text-primary">${{ total_due }}</h4>
                </div>
            </div>

            <input type="hidden" name="gateway" value="stripe">

            <div class="d-grid mt-4">
                <button type="submit" class="btn btn-onboarding btn-lg">
                    <i class="bi bi-lock me-2"></i>
                    Pay Now
                </button>
            </div>

            <p class="text-center text-muted small mt-3">
                <i class="bi bi-shield-check me-1"></i>
                Secure payment processing
            </p>
        </form>
        {% endif %}

        {% if failed_payments %}
        <div class="alert alert-danger mt-4">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Payment Failed
            </h6>
            {% for payment in failed_payments %}
            <p class="mb-1">{{ payment.description }}: {{ payment.last_error }}</p>
            {% endfor %}
            <hr>
            <p class="mb-0 small">Please try again or contact your property manager for assistance.</p>
        </div>
        {% endif %}
    </div>

    {% if all_paid %}
    <div class="onboarding-card-footer d-flex justify-content-between">
        <span></span>
        <form method="post" action="{% url 'tenant_lifecycle:onboarding_payments_complete' token=session.access_token %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-onboarding">
                Continue
                <i class="bi bi-arrow-right ms-2"></i>
            </button>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}
