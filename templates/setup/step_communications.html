{% extends "setup/base_wizard.html" %}

{% block step_content %}
<div class="mb-4">
    <p class="text-muted">
        Configure email and/or SMS to send notifications, OTP codes, and reminders to tenants.
        At least one communication method is recommended.
    </p>
</div>

<form id="stepForm" method="post">
    {% csrf_token %}

    <!-- Email Configuration -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-envelope me-2"></i>
                <strong>Email Configuration</strong>
            </div>
            <span class="badge bg-info">Recommended</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="id_email-email_host" class="form-label">SMTP Host</label>
                    {{ email_form.email_host }}
                    <div class="form-text">e.g., smtp.gmail.com, smtp.sendgrid.net</div>
                </div>
                <div class="col-md-4">
                    <label for="id_email-email_port" class="form-label">Port</label>
                    {{ email_form.email_port }}
                </div>
                <div class="col-md-6">
                    <label for="id_email-email_host_user" class="form-label">Username / Email</label>
                    {{ email_form.email_host_user }}
                </div>
                <div class="col-md-6">
                    <label for="id_email-email_host_password" class="form-label">Password / API Key</label>
                    {{ email_form.email_host_password }}
                </div>
                <div class="col-md-6">
                    <label for="id_email-default_from_email" class="form-label">From Email Address</label>
                    {{ email_form.default_from_email }}
                </div>
                <div class="col-md-6">
                    <div class="pt-4">
                        <div class="form-check form-check-inline">
                            {{ email_form.email_use_tls }}
                            <label class="form-check-label" for="id_email-email_use_tls">Use TLS</label>
                        </div>
                        <div class="form-check form-check-inline">
                            {{ email_form.email_use_ssl }}
                            <label class="form-check-label" for="id_email-email_use_ssl">Use SSL</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        hx-post="{% url 'setup:test_email' %}"
                        hx-include="[name^='email-']"
                        hx-target="#email-test-result"
                        hx-indicator="#email-test-spinner">
                    <span id="email-test-spinner" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-envelope-check me-1"></i> Test Email
                </button>
                <span id="email-test-result" class="ms-2"></span>
            </div>
        </div>
    </div>

    <!-- SMS Configuration -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-chat-dots me-2"></i>
                <strong>SMS Configuration (Twilio)</strong>
            </div>
            <span class="badge bg-secondary">Optional</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-12">
                    <label for="id_sms-account_sid" class="form-label">Account SID</label>
                    {{ sms_form.account_sid }}
                    <div class="form-text">Found in your Twilio Console</div>
                </div>
                <div class="col-md-6">
                    <label for="id_sms-auth_token" class="form-label">Auth Token</label>
                    {{ sms_form.auth_token }}
                </div>
                <div class="col-md-6">
                    <label for="id_sms-phone_number" class="form-label">Twilio Phone Number</label>
                    {{ sms_form.phone_number }}
                    <div class="form-text">e.g., +15551234567</div>
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        hx-post="{% url 'setup:test_sms' %}"
                        hx-include="[name^='sms-']"
                        hx-target="#sms-test-result"
                        hx-indicator="#sms-test-spinner">
                    <span id="sms-test-spinner" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-phone me-1"></i> Test Credentials
                </button>
                <span id="sms-test-result" class="ms-2"></span>
            </div>
        </div>
    </div>

    {% if email_form.errors or sms_form.errors %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Please correct the errors above.
    </div>
    {% endif %}
</form>

{% block extra_js %}
{{ block.super }}
<script>
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            const targetId = evt.detail.target.id;
            const resultSpan = document.getElementById(targetId);
            if (response.success) {
                resultSpan.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>' + response.message + '</span>';
            } else {
                resultSpan.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>' + response.message + '</span>';
            }
        } catch (e) {}
    }
});
</script>
{% endblock %}
{% endblock %}
