{% load core_tags %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">
        <i class="bi bi-building"></i> {{ config.property.name }}
    </h5>
    {% if config.is_active %}
    <span class="badge bg-success">Active</span>
    {% else %}
    <span class="badge bg-secondary">Inactive</span>
    {% endif %}
</div>

<div class="mb-4">
    <h6 class="border-bottom pb-2"><i class="bi bi-bell"></i> Active Notification Rules</h6>
    {% if applicable_rules %}
    <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0">
            <thead class="table-light">
                <tr>
                    <th>Rule Name</th>
                    <th>Alert Type</th>
                    <th>Severity</th>
                    <th>Cooldown</th>
                    <th>Scope</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in applicable_rules %}
                <tr>
                    <td>{{ rule.name }}</td>
                    <td><span class="badge bg-secondary">{{ rule.get_alert_type_display }}</span></td>
                    <td>
                        {% if rule.severity == "emergency" %}
                        <span class="badge bg-danger">Emergency</span>
                        {% elif rule.severity == "warning" %}
                        <span class="badge bg-warning text-dark">Warning</span>
                        {% elif rule.severity == "watch" %}
                        <span class="badge bg-info text-dark">Watch</span>
                        {% else %}
                        <span class="badge bg-primary">All</span>
                        {% endif %}
                    </td>
                    <td>{{ rule.cooldown_hours }}h</td>
                    <td>{% if rule.property %}This Property{% else %}<em>All Properties</em>{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No active notification rules apply to this property.</p>
    {% endif %}
</div>

<div class="mb-4">
    <h6 class="border-bottom pb-2"><i class="bi bi-clock"></i> Last Notification Sent</h6>
    {% if last_dispatch %}
    <div class="card card-body bg-light">
        <div class="row">
            <div class="col-sm-6">
                <strong>Rule:</strong> {{ last_dispatch.rule.name }}<br>
                <strong>Subject:</strong> {{ last_dispatch.rendered_subject }}
            </div>
            <div class="col-sm-6">
                <strong>Sent:</strong> {{ last_dispatch.dispatched_at|date:"M d, Y H:i" }}<br>
                <strong>Tenants Notified:</strong>
                <span class="badge bg-primary">{{ last_dispatch.tenants_notified }}</span>
            </div>
        </div>
    </div>
    {% else %}
    <p class="text-muted mb-0">No notifications have been dispatched for this property yet.</p>
    {% endif %}
</div>

<div class="mb-4">
    <h6 class="border-bottom pb-2"><i class="bi bi-clock-history"></i> Notification History</h6>
    {% if dispatch_history %}
    <div style="max-height: 200px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Date</th>
                    <th>Rule</th>
                    <th>Subject</th>
                    <th>Tenants</th>
                </tr>
            </thead>
            <tbody>
                {% for log in dispatch_history %}
                <tr>
                    <td class="text-nowrap">{{ log.dispatched_at|date:"M d, H:i" }}</td>
                    <td>{{ log.rule.name }}</td>
                    <td>{{ log.rendered_subject|truncatechars:40 }}</td>
                    <td><span class="badge bg-primary">{{ log.tenants_notified }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No dispatch history.</p>
    {% endif %}
</div>

<div class="mb-4">
    <h6 class="border-bottom pb-2"><i class="bi bi-exclamation-triangle"></i> Recent Weather Alerts</h6>
    {% if recent_alerts %}
    <div style="max-height: 200px; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Severity</th>
                    <th>Title</th>
                    <th>Notified</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in recent_alerts %}
                <tr>
                    <td class="text-nowrap">{{ alert.created_at|date:"M d, H:i" }}</td>
                    <td><span class="badge bg-secondary">{{ alert.get_alert_type_display }}</span></td>
                    <td>
                        {% if alert.severity == "emergency" %}
                        <span class="badge bg-danger">Emergency</span>
                        {% elif alert.severity == "warning" %}
                        <span class="badge bg-warning text-dark">Warning</span>
                        {% else %}
                        <span class="badge bg-info text-dark">Watch</span>
                        {% endif %}
                    </td>
                    <td>{{ alert.title|truncatechars:30 }}</td>
                    <td>
                        {% if alert.notification_sent %}
                        <i class="bi bi-check-circle-fill text-success"></i>
                        {% else %}
                        <i class="bi bi-dash-circle text-muted"></i>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-muted mb-0">No weather alerts for this property.</p>
    {% endif %}
</div>

<div class="border-top pt-3">
    <h6 class="mb-3"><i class="bi bi-lightning"></i> Actions</h6>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary btn-sm"
                onclick="forceAction('poll', '{{ config.pk }}')">
            <i class="bi bi-arrow-clockwise"></i> Force Re-Poll Weather
        </button>
        {% if latest_alert %}
        <button type="button" class="btn btn-outline-warning btn-sm"
                onclick="forceAction('notify', '{{ config.pk }}')">
            <i class="bi bi-send"></i> Force Re-Run Notifications
        </button>
        {% else %}
        <button type="button" class="btn btn-outline-warning btn-sm" disabled
                title="No alerts exist for this property">
            <i class="bi bi-send"></i> Force Re-Run Notifications
        </button>
        {% endif %}
    </div>
    <div id="action-feedback-{{ config.pk }}" class="mt-2"></div>
</div>
