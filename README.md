# PropManager

A full-featured property management application built with Django for small-scale landlords managing residential properties and tenants.

## Features

- **Multi-Portal Architecture** - Separate portals for admins, tenants, and contractors
- **Passwordless Tenant Login** - Email/SMS OTP authentication (no passwords for tenants)
- **Admin 2FA** - Optional two-factor authentication for admin accounts
- **Billing & Invoicing** - Automated invoice generation, payment tracking, aging receivables
- **Pluggable Payment Gateways** - Stripe, PayPal, and Square support (admin-configurable)
- **Work Order Management** - Full lifecycle from tenant submission to contractor completion
- **Contractor Token Access** - Secure, expiring links for contractors (no account required)
- **Communications** - In-app messaging, notifications, and announcements
- **Document Management** - Upload, categorize, and share documents with tenants
- **Weather Monitoring** - OpenWeatherMap integration with automatic tenant alerts
- **Marketing Campaigns** - Email campaigns with segmentation, scheduling, and open/click tracking
- **Reports & CSV Export** - Rent roll, aging receivables, payment history, work order summary

## Tech Stack

| Component | Technology |
|---|---|
| Framework | Django 5.x |
| Database | PostgreSQL (production), SQLite (development) |
| Task Queue | Django-Q2 (ORM-backed) |
| Frontend | Django Templates + HTMX + Bootstrap 5 |
| Forms | django-crispy-forms + crispy-bootstrap5 |
| SMS | Twilio |
| Payments | Stripe / PayPal / Square (pluggable) |
| Weather | OpenWeatherMap API |
| Static Files | WhiteNoise |

## Quick Start

### Prerequisites

- Python 3.10+
- pip
- (Optional) PostgreSQL for production

### 1. Clone and set up the virtual environment

```bash
cd propmanager
python3 -m venv venv
source venv/bin/activate
pip install -r requirements/base.txt
```

### 2. Configure environment

```bash
cp .env.example .env
# Edit .env with your settings (defaults work for development)
```

### 3. Run migrations

```bash
python manage.py migrate
```

### 4. Seed development data

```bash
python manage.py seed_dev_data
```

This creates default accounts, sample properties, leases, invoices, work orders, and more. See [Default Accounts](#default-accounts) below.

### 5. Start the development server

```bash
python manage.py runserver 0.0.0.0:8000
```

Visit `http://localhost:8000` to get started.

## Default Accounts

After running `python manage.py seed_dev_data`, the following accounts are available:

### Admin Portal (`/admin-portal/login/`)

| Username | Password | Role | Description |
|---|---|---|---|
| `admin` | `admin123` | Admin | Full access, superuser |
| `staff` | `staff123` | Staff | Full admin portal access |

### Tenant Portal (`/tenant/login/`)

Tenants use passwordless OTP login. In development, the OTP code is always **`123456`** (configured via `DEV_OTP_CODE` in `config/settings/development.py`).

| Email | Password | Name | Unit |
|---|---|---|---|
| `tenant1@example.com` | `tenant123` | Jane Smith | Sunset Apts #101 |
| `tenant2@example.com` | `tenant123` | Bob Johnson | Sunset Apts #102 |
| `tenant3@example.com` | `tenant123` | Maria Garcia | Sunset Apts #103 |
| `tenant4@example.com` | `tenant123` | David Williams | Sunset Apts #104 |
| `tenant5@example.com` | `tenant123` | Sarah Brown | Sunset Apts #105 |

### Django Admin (`/django-admin/`)

| Username | Password |
|---|---|
| `admin` | `admin123` |

### Contractor Access

Contractor links are generated by admins when assigning work orders. No accounts needed - contractors access their assigned work orders via unique token URLs (e.g., `/contractor/<token>/`).

## Sample Data

The seed command creates:

- **3 properties**: Sunset Apartments (8 units), Maple Grove Townhomes (4 units), Oak Street House (1 unit)
- **5 active leases** across Sunset Apartments
- **10 invoices** (current month issued + last month paid)
- **5 work orders** in various statuses (created, verified, assigned, in_progress, completed)
- **2 announcements**, message threads, and notifications
- **6 document categories** (Lease Agreements, Inspections, Financial, etc.)

## Project Structure

```
propmanager/
    config/              # Django settings (base/development/production), URLs
    apps/
        core/            # Abstract models, services, decorators, middleware, reports
        accounts/        # Users, auth, OTP, profiles, contractor tokens
        properties/      # Properties, units, amenities
        leases/          # Leases, terms, terminations
        billing/         # Invoices, payments, payment gateways
        workorders/      # Work orders, contractor assignments, notes, images
        communications/  # Messages, notifications, announcements
        documents/       # File uploads, categories
        weather/         # Weather monitoring, alerts
        marketing/       # Email campaigns, segmentation, tracking
    templates/           # All HTML templates organized by app
    static/              # CSS, JS, images
    media/               # User uploads (gitignored)
    requirements/        # Dependency files (base/dev/prod)
```

## URL Structure

| Portal | Base URL | Login URL |
|---|---|---|
| Tenant | `/tenant/` | `/tenant/login/` |
| Admin | `/admin-portal/` | `/admin-portal/login/` |
| Contractor | `/contractor/<token>/` | N/A (token-based) |
| Django Admin | `/django-admin/` | `/django-admin/` |

## Documentation

See the [`docs/`](docs/) directory for detailed documentation:

- [Architecture Overview](docs/architecture.md) - System design, data models, authentication flows
- [API & Services](docs/services.md) - Payment gateways, SMS, email, weather services
- [Deployment Guide](docs/deployment.md) - Production setup, environment variables, PostgreSQL, Django-Q2

## Configuration

All configuration is via environment variables (`.env` file). Key settings:

| Variable | Description | Required |
|---|---|---|
| `SECRET_KEY` | Django secret key | Yes (production) |
| `DEBUG` | Debug mode | No (default: False) |
| `DATABASE_URL` | PostgreSQL connection string | Production only |
| `TWILIO_ACCOUNT_SID` | Twilio account SID | For SMS features |
| `TWILIO_AUTH_TOKEN` | Twilio auth token | For SMS features |
| `TWILIO_PHONE_NUMBER` | Twilio sender number | For SMS features |
| `OPENWEATHERMAP_API_KEY` | Weather API key | For weather features |
| `STRIPE_SECRET_KEY` | Stripe API key | For Stripe payments |
| `PAYPAL_CLIENT_ID` | PayPal client ID | For PayPal payments |
| `SQUARE_ACCESS_TOKEN` | Square access token | For Square payments |

See [`.env.example`](.env.example) for the complete list.

## Management Commands

| Command | Description |
|---|---|
| `python manage.py seed_dev_data` | Create dev accounts and sample data |
| `python manage.py seed_dev_data --reset` | Flush DB and reseed everything |
| `python manage.py createsuperuser` | Create a new admin user manually |

## Background Tasks (Django-Q2)

Start the task worker for background processing:

```bash
python manage.py qcluster
```

Tasks include:
- Invoice generation and overdue detection
- OTP delivery (email/SMS)
- Weather polling and alert generation
- Marketing campaign sending
- Notification dispatch

## License

Proprietary. All rights reserved.
